# msgp

**msgp** は、ソースコード中の文字列リテラルを抽出・評価するマルチランゲージの検索ツールです。  
エラーメッセージだけでなく任意のメッセージを対象に、C/C++、Python、JavaScript/JSX の各ソースから文字列リテラルを抽出し、指定したメッセージとの一致度に基づいてスコアを計算します。

## 特徴

- **マルチランゲージ対応:**  
  - **C/C++:** `.c`, `.h`, `.cpp`, `.cc` ファイルをスキャン  
  - **Python:** `.py` ファイルをスキャン  
  - **JavaScript:** `.js` および `.jsx` ファイルをスキャン

- **メッセージ抽出:**  
  評価対象は文字列リテラルのみで、ファイル名や関数定義はスコア計算の対象外です。

- **スコアリング機構:**  
  指定されたメッセージと各文字列リテラルのトークン（空白、英数字、記号など）を比較し、以下のルールでスコアを計算します。  
  - 英数字とドットのみのトークンは、1文字あたり1点。  
  - 空白や記号などのトークンは、1文字あたり0.1点。  
  トークンの出現順序もチェックし、一致していればスコアが加算されます。

- **出力のカスタマイズ:**  
  - grep の `-A`, `-B`, `-C` オプションに似た形で、マッチ行の前後のコンテキスト行を表示可能。  
  - `--sort` オプションでスコア順にソートすることができます。  
  - `-H`/`--with-filename` および `-n` オプションで、ファイル名や行番号のプレフィックスを付与できます。  
  - ANSIカラーコードによるハイライトもサポート（端末出力の場合は自動有効）。

- **並列処理:**  
  システムの論理CPU数に合わせたスレッドプールを使用し、複数のファイルを並列に処理することで大規模なコードベースでの検索を高速化します。

- **エラーの抑制:**  
  標準出力が途中で切断された場合（例：`head` でパイプ処理する場合）でも、BrokenPipeError を無視して正常に終了します。

## 必要条件

- Python 3.6 以上  
  （msgp は Python 標準ライブラリのみを利用しています。）

## インストール

`msgp` スクリプトをダウンロードし、実行可能にします。

```bash
chmod +x msgp
```

その後、以下のように直接実行できます。

```bash
./msgp [オプション] <メッセージ> <ディレクトリ>
```

## 使い方

```bash
./msgp [オプション] <メッセージ> <ディレクトリ>
```

### オプション

- `<メッセージ>`  
  検索対象のメッセージ（例: `"Memory: 16G (min: 250M peak: 27G swap: 2.8G swap peak: 6.7G)"`）。

- `<ディレクトリ>`  
  再帰的にソースファイルを検索するルートディレクトリ。

- `-n`  
  出力時に行番号を表示する。

- `-A <N>`  
  マッチ行の後に N 行を表示する。

- `-B <N>`  
  マッチ行の前に N 行を表示する。

- `-C <N>`  
  マッチ行の前後に N 行を表示する（`-A`、`-B` が指定されていない場合に使用）。

- `--score <値>`  
  指定したスコア以上の候補のみを出力します。

- `--sort`  
  結果をスコアの高い順にソートして表示します。

- `-H` または `--with-filename`  
  各マッチ行にファイル名を表示し、候補概要行を省略します（grep の -H に似た動作）。

- `--color`  
  カラー表示を強制的に有効にします。

- `--nocolor`  
  カラー表示を強制的に無効にします。

## 利用例

### 1. 基本的な検索

指定したディレクトリ内の全ての対応ソースファイルからメッセージを検索します。

```bash
./msgp "Memory: 16G (min: 250M peak: 27G swap: 2.8G swap peak: 6.7G)" ~/projects/mycode
```

### 2. スコアでフィルタリング

スコアが少なくとも6以上の候補のみを表示します。

```bash
./msgp --score 6 "Memory: 16G (min: 250M peak: 27G swap: 2.8G swap peak: 6.7G)" ~/projects/mycode
```

### 3. コンテキスト行の表示

マッチ行の前に2行、後に3行のコンテキストを表示します。

```bash
./msgp -B 2 -A 3 "Memory: 16G (min: 250M peak: 27G swap: 2.8G swap peak: 6.7G)" ~/projects/mycode
```

または、前後同じ行数を表示する `-C` オプションを使用して：

```bash
./msgp -C 3 "Memory: 16G (min: 250M peak: 27G swap: 2.8G swap peak: 6.7G)" ~/projects/mycode
```

### 4. ソートされた出力

スコアの高い順に並べ替えて表示します。

```bash
./msgp --score 4 --sort "Memory: 16G (min: 250M peak: 27G swap: 2.8G swap peak: 6.7G)" ~/projects/mycode
```

### 5. ファイル名の表示

各マッチ行にファイル名をプレフィックスとして表示し、候補概要行は省略します（grep の -H オプションに似た動作）。

```bash
./msgp -H "Memory: 16G (min: 250M peak: 27G swap: 2.8G swap peak: 6.7G)" ~/projects/mycode
```

## 仕組み

1. **トークン化:**  
   指定されたメッセージは、事前にコンパイルされた正規表現を使って、空白、英数字・ドット、記号に分割されます。

2. **文字列リテラルの抽出:**  
   対応するファイル拡張子（C/C++、Python、JavaScript）に応じた関数を使い、ソースファイルから文字列リテラルを抽出します。

3. **スコアリング:**  
   抽出された文字列リテラルからフォーマット指定子（例: `%-06d` や `%10s`）を除去し、トークン化します。  
   その後、メッセージのトークンと比較して、順序が一致しているかどうかを確認し、各トークンに対して上記のルールに基づいたスコアを計算します。

4. **出力:**  
   指定されたスコア以上の候補が、オプションに応じた形式で出力されます（コンテキスト行、色付け、ファイル名/行番号の表示など）。

5. **並列処理:**  
   論理CPU数に応じたスレッドプールを使用して、複数のファイルを並列に処理し、検索速度を向上させています。

## ライセンス

このプロジェクトは **BSD 2-Clause License** のもとで提供されています。

